# AI应用后端接口架构设计文档

## 1. 项目概述

### 1.1 项目描述
基于Python FastAPI框架实现的小型AI应用后端接口，集成DeepSeek大语言模型，提供中译英、英译中、内容总结等核心功能。采用同步执行模式，简化系统复杂度，适合中小型应用场景。

### 1.2 核心特性
- 对接DeepSeek大语言模型API
- 支持中译英、英译中、文本总结功能
- 同步任务执行，直接返回结果
- 流式响应支持，实时数据传输
- RESTful API设计，标准化接口规范
- SQLite数据库存储，轻量级部署

### 1.3 技术栈
- **后端框架**: FastAPI (高性能异步Web框架)
- **数据库**: SQLite (轻量级关系型数据库)
- **大模型接口**: DeepSeek API (兼容OpenAI格式)
- **HTTP客户端**: OpenAI Python SDK
- **流式响应**: Server-Sent Events (SSE)
- **缓存策略**: SQLite表缓存 + 内存缓存

## 2. 系统架构


### 2.2 架构层次设计

#### 2.2.1 接口层 (API Layer)
**职责**: HTTP请求处理、参数验证、响应格式化

**核心组件**:
- **路由处理器**: 处理不同的API端点请求
- **请求验证中间件**: 验证输入参数的合法性和完整性
- **响应格式化器**: 统一响应格式，确保API一致性
- **CORS处理器**: 跨域资源共享配置

**设计原则**:
- 遵循RESTful设计规范
- 统一的错误响应格式
- 完整的请求参数验证
- 标准化的HTTP状态码使用

#### 2.2.2 业务逻辑层 (Business Layer)
**职责**: 核心业务逻辑处理、DeepSeek API调用、流程控制

**核心组件**:
- **功能服务管理器**: 管理所有可用的AI功能（翻译、总结等）
- **DeepSeek调用处理器**: 封装DeepSeek API调用逻辑
- **流式响应管理器**: 处理实时数据流传输
- **结果处理器**: 处理和格式化AI模型返回结果

**设计原则**:
- 单一职责原则，每个组件专注特定功能
- 依赖注入，便于测试和维护
- 统一异常处理机制
- 可扩展的功能注册机制

#### 2.2.3 数据访问层 (Data Layer)
**职责**: 数据持久化

**核心组件**:
- **数据库访问对象**: SQLite数据库操作封装

**设计原则**:
- 数据访问与业务逻辑分离
- 事务管理确保数据一致性
- 索引优化提升查询效率

#### 2.2.4 外部服务层 (External Service Layer)
**职责**: DeepSeek API集成、第三方服务调用
**核心组件**:
- **DeepSeek客户端适配器**: 基于OpenAI SDK的DeepSeek API适配器
- **外部API管理器**: 统一的外部服务调用管理

**设计原则**:
- 兼容OpenAI SDK，降低学习成本
- 完善的错误处理和重试策略
- API调用监控和统计
- 灵活的配置管理

## 3. 核心模块设计

### 3.1 功能管理模块

**模块职责**: 负责AI功能的注册、管理和执行调度

**核心功能**:

**功能注册机制**:
- 支持动态注册新的AI功能（翻译、总结等）
- 每个功能包含：功能ID、名称、描述、系统提示词、模型参数
- 功能配置存储在数据库中，支持运行时修改
- 支持功能的启用/禁用状态管理

**功能元数据管理**:
- 输入参数Schema定义和验证
- 输出格式Schema定义
- 模型参数配置（temperature、max_tokens等）
- 执行时间预估和资源限制

**功能执行调度**:
- 根据功能ID选择对应的执行器
- 输入参数验证和预处理
- 执行结果的后处理和格式化
- 执行统计和监控数据收集

**支持的功能类型**:
- **translation_zh_to_en**: 中译英翻译功能
- **translation_en_to_zh**: 英译中翻译功能
- **text_summary**: 文本总结功能

### 3.2 DeepSeek适配器模块

**模块职责**: DeepSeek API的集成和调用封装

**核心功能**:

**API客户端初始化**:
- 从数据库读取DeepSeek API配置
- 基于OpenAI SDK创建DeepSeek客户端
- 支持API密钥、基础URL等配置管理
- 客户端连接池和超时配置

**同步调用支持**:
- 封装DeepSeek chat completions API
- 支持多种模型选择（deepseek-chat、deepseek-reasoner）
- 完整的请求参数构建和响应解析

**流式调用支持**:
- 实现Server-Sent Events流式响应
- 支持实时数据传输和增量内容显示
- 流式传输的错误处理和恢复机制
- 流式数据的格式化和压缩

**消息格式处理**:
- 系统提示词和用户消息的组合
- 消息历史管理和上下文维护
- 特殊格式消息的处理（如prefix completion）
- 响应内容的解析和提取



### 3.3 流式响应模块

**模块职责**: 实时数据流的生成、传输和管理

**核心功能**:

**流式会话管理**:
- 创建和维护流式会话状态
- 会话ID生成和生命周期管理
- 多个并发流的管理和资源控制
- 会话超时和清理机制

**数据流生成**:
- 将DeepSeek流式响应转换为SSE格式
- 数据块的分割和序列化
- 时间戳和进度信息的添加
- 流式数据的压缩和优化

**连接管理**:
- 客户端连接状态监控
- 连接断开的检测和处理
- 背压控制和流量调节
- 连接池的管理和复用

**流式数据处理**:
- 内容块的增量传输
- 使用统计信息的实时收集
- 错误信息的流式传输
- 流式结束信号的发送



## 4. API接口设计

### 4.1 功能列表接口

**接口路径**: `GET /api/v1/functions`

**功能描述**: 获取系统中所有可用的AI功能列表

**请求参数**: 无

**响应格式**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "功能唯一标识",
      "name": "功能显示名称",
      "description": "功能详细描述",
      "input_schema": {
        "type": "object",
        "properties": {
          "输入参数定义": "参数类型和约束"
        },
        "required": ["必需参数列表"]
      },
      "max_input_length": "最大输入长度限制",
      "estimated_time": "预估执行时间（秒）",
      "supports_stream": "是否支持流式响应",
      "model_used": "使用的DeepSeek模型"
    }
  ]
}
```

**业务逻辑**:
1. 从functions表查询所有is_active=1的功能
2. 按创建时间倒序排列
3. 格式化输出为标准JSON格式
4. 包含完整的输入输出Schema定义

### 4.2 同步功能执行接口

**接口路径**: `POST /api/v1/execute`

**功能描述**: 同步执行指定的AI功能，直接返回结果

**请求格式**:
```json
{
  "function_id": "要执行的功能ID",
  "input": {
    "输入参数名": "参数值"
  },
  "use_cache": "是否使用缓存（可选，默认true）",
  "model_name": "指定模型（可选，覆盖默认配置）"
}
```

**响应格式**:
```json
{
  "code": 200,
  "message": "执行成功",
  "data": {
    "function_id": "执行的功能ID",
    "result": {
      "content": "AI生成的结果内容"
    },
    "usage": {
      "input_tokens": "输入Token数量",
      "output_tokens": "输出Token数量",
      "total_tokens": "总Token数量"
    },
    "execution_time": "执行时间（秒）",
    "model_used": "实际使用的模型",
    "cached": "是否来自缓存"
  }
}
```

**业务逻辑流程**:
1. **参数验证**: 验证function_id是否存在且启用，验证input参数是否符合schema
3. **API调用**: 缓存未命中时，调用DeepSeek API执行功能
4. **结果处理**: 解析API响应，提取内容和统计信息
7. **响应返回**: 格式化结果并返回给客户端

**错误处理**:
- 功能不存在或未禁用：返回404错误
- 输入参数验证失败：返回400错误及具体原因
- DeepSeek API调用失败：返回502错误
- 执行超时：返回408错误
- 系统内部错误：返回500错误

### 4.3 流式响应接口

**接口路径**: `POST /api/v1/stream`

**功能描述**: 流式执行AI功能，实时返回生成过程

**请求格式**:
```json
{
  "function_id": "要执行的功能ID",
  "input": {
    "输入参数名": "参数值"
  },
  "stream_mode": "流式模式（tokens/chunks/sentences）",
  "use_cache": "是否使用缓存（可选，流式模式默认false）"
}
```

**响应格式**: Server-Sent Events (SSE) 流

**流数据格式**:
```
data: {"type": "start", "function_id": "功能ID", "timestamp": "开始时间"}

data: {"type": "token", "content": "生成的文本片段", "timestamp": "生成时间"}

data: {"type": "end", "usage": {"token统计"}, "execution_time": "总执行时间", "timestamp": "结束时间"}

data: {"type": "error", "message": "错误信息", "timestamp": "错误时间"}
```

**业务逻辑流程**:
1. **会话创建**: 生成唯一的流式会话ID
2. **参数验证**: 验证function_id和输入参数
3. **流式调用**: 创建DeepSeek API流式请求
4. **数据转换**: 将API流式响应转换为SSE格式
5. **实时传输**: 通过HTTP连接实时传输数据块
6. **状态监控**: 监控连接状态，处理断线重连
7. **完成处理**: 发送结束信号，清理会话资源



## 5. 数据模型设计

### 5.1 数据库架构概述

**设计理念**: 基于SQLite轻量级数据库，专注于AI对话结果的持久化存储，采用最简化设计，仅通过单张表存储完整的对话记录。

**核心原则**:
- 极简设计：单表存储所有对话相关数据
- 高效存储：对话结束后一次性存储完整结果
- 易于维护：减少表间关联，简化数据管理
- 性能优先：针对简单查询场景优化

**数据库特性**:
- SQLite 3.x 版本，支持完整的SQL标准
- 文件型数据库，无需独立数据库服务
- 支持事务ACID特性
- 简化的数据模型，降低维护复杂度

### 5.2 核心数据表设计

#### 5.2.1 对话记录表 (conversations)

**表职责**: 存储完整的AI对话记录，包括用户输入和AI回复结果

**表结构定义**:
```sql
CREATE TABLE conversations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    conversation_id VARCHAR(36) NOT NULL UNIQUE,
    function_id VARCHAR(50) NOT NULL,
    function_name VARCHAR(100) NOT NULL,
    model_used VARCHAR(50) NOT NULL,
    user_input TEXT NOT NULL,
    ai_response TEXT NOT NULL,
    total_tokens INTEGER DEFAULT 0,
    execution_time DECIMAL(10,3) DEFAULT 0.000,
    status VARCHAR(20) NOT NULL DEFAULT 'completed',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    metadata TEXT
);
```

**字段说明**:
- `id`: 自增主键，内部关联使用
- `conversation_id`: UUID格式的对话唯一标识符
- `function_id`: 执行的AI功能ID（translation_zh_to_en、translation_en_to_zh、text_summary）
- `function_name`: 功能名称（中译英、英译中、文本总结）
- `model_used`: 实际使用的DeepSeek模型名称
- `user_input`: 用户的原始输入文本
- `ai_response`: AI生成的完整回复结果
- `total_tokens`: 整个对话消耗的总Token数量
- `execution_time`: 对话执行时间（秒）
- `status`: 对话状态（completed/failed/timeout）
- `created_at`: 对话完成时间戳
- `metadata`: JSON格式的额外元数据（如参数配置、错误信息等）

**索引设计**:
```sql
CREATE INDEX idx_conversations_id ON conversations(conversation_id);
CREATE INDEX idx_conversations_function ON conversations(function_id);
CREATE INDEX idx_conversations_created_at ON conversations(created_at);
CREATE INDEX idx_conversations_status ON conversations(status);
```








